name: QMK Build - kagizara/miniaxe

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      keymap:
        description: 'Keymap to compile'
        required: false
        default: 'default'

env:
  KEYBOARD: 'kagizara/miniaxe'
  KEYMAP: 'default'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Resolve KEYMAP (dispatch input overrides default)
      run: |
        echo "KEYMAP=${{ github.event.inputs.keymap != '' && github.event.inputs.keymap || env.KEYMAP }}" >> $GITHUB_ENV

    - name: Build firmware with QMK Docker
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/qmk_firmware" \
          -w /qmk_firmware \
          --user "$(id -u):$(id -g)" \
          -e KEYBOARD="${KEYBOARD}" \
          -e KEYMAP="${KEYMAP}" \
          qmkfm/qmk_cli:latest \
          bash -lc "set -euo pipefail
          qmk setup -y
          qmk compile -kb \"$KEYBOARD\" -km \"$KEYMAP\""
      env:
        KEYBOARD: ${{ env.KEYBOARD }}
        KEYMAP: ${{ env.KEYMAP }}

    - name: Show build output (debug)
      if: always()
      run: |
        echo "Workspace: $GITHUB_WORKSPACE"
        ls -la "$GITHUB_WORKSPACE"
        echo ".build contents:"
        ls -la "$GITHUB_WORKSPACE/.build" || true

    - name: Upload firmware artifact (.hex)
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ env.KEYBOARD }}-${{ env.KEYMAP }}
        path: ./.build/*.hex
