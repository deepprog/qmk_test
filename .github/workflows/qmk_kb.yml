name: QMK Build - kagizara/miniaxe
on: [push, workflow_dispatch]
env:
  KEYBOARD: kagizara/miniaxe
  KEYMAP: default

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Prepare qmk_firmware and copy custom keyboards
      run: |
        set -eux
        git clone --depth=1 https://github.com/qmk/qmk_firmware.git qmk_firmware
        # もしリポジトリ内に keyboards/ があれば qmk_firmware にコピー
        if [ -d keyboards ]; then
          cp -a keyboards/* qmk_firmware/keyboards/ || true
        fi

    - name: Build inside QMK Docker
      run: |
        docker run --rm \
          -v "${{ github.workspace }}/qmk_firmware:/qmk_firmware" \
          -w /qmk_firmware \
          --user "$(id -u):$(id -g)" \
          qmkfm/qmk_cli:latest \
          bash -lc "qmk setup -y || true && qmk compile -kb '${{ env.KEYBOARD }}' -km '${{ env.KEYMAP }}'"
      env:
        KEYBOARD: ${{ env.KEYBOARD }}
        KEYMAP: ${{ env.KEYMAP }}

    - name: Debug list .build
      if: always()
      run: |
        echo "qmk_firmware/.build:"
        ls -la qmk_firmware/.build || true
        echo "repo root .build:"
        ls -la ./.build || true

    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: |
          qmk_firmware/.build/*.hex
          ./.build/*.hex

